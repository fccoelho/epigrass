
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Writing Custom Models {#custom} &#8212; Epigrass 2.6.1 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Analysis" href="analysis.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="writing-custom-models-custom">
<h1>Writing Custom Models {#custom}<a class="headerlink" href="#writing-custom-models-custom" title="Permalink to this headline">¶</a></h1>
<p>::: {.index}
custom models
::</p>
<p>The most powerful feature of Epigrass is the ability to use custom
models. It allows the user to specify intra-node dynamics and, in doing
so, break away from the limitations imposed by the built-in models.</p>
<p>By learning to write his/her own models, the user begins to realize the
full potential of Epigrass, which goes beyond being a platform to
simulate networked epidemics. In reality Epigrass can be used to model
any distributed dynamical system taking place on a set of nodes
(connected or not).</p>
<div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>The best way to get started in writing custom models is to look at the
example distributed with Epigrass. It can be found in
<a href="#id1"><span class="problematic" id="id2">`</span></a>demos/CustomModel_example.py`{.interpreted-text role=”file”}:</p>
<blockquote>
<div><p># This is a custom model to used in place of Epigrass’ built-in models. Custom
# models must always be on a file named CustomModel.py and contain at least
# a function named Model. Both the File name and the function Names are case-sensitive,
# so be careful. Please refer to the manual for intructions on how to write your
# own custom models.</p>
<dl>
<dt>def Model(self,vars,par,theta=0, npass=0):</dt><dd><p>“””
Calculates the model SIR, and return its values.
* vars The state variables of the models
* par  The parameters (Beta, alpha, E,r,delta,B, w, p) see docs.
* theta = infectious individuals from neighbor sites
* npass = Total number of people arriving at this node
“””
# Get state variables’ current values</p>
<dl>
<dt>if self.parentSite.parentGraph.simstep == 1:  # if first step</dt><dd><p># Define variable names to appear in the output
self.parentSite.vnames = (‘Exposed’,’Infectious’,’Susceptible’)
# And get state variables’s initial values (stored in dict self.bi)</p>
<p>E,I,S = (self.bi[‘e’],self.bi[‘i’],self.bi[‘s’])</p>
</dd>
<dt>else:   # if nor first step</dt><dd><p>E,I,S = vars</p>
</dd>
</dl>
<p># Get parameter values
N = self.parentSite.totpop
beta,alpha,e,r,delta,B,w,p = (self.bp[‘beta’],self.bp[‘alpha’],
self.bp[‘e’],self.bp[‘r’],self.bp[‘delta’],self.bp[‘b’],
self.bp[‘w’],self.bp[‘p’])</p>
<p>#Vacination event (optional)
if self.parentSite.vaccineNow:</p>
<blockquote>
<div><p>S -= self.parentSite.vaccov*S</p>
</div></blockquote>
<p># Model
Lpos = beta*S*((I+theta)/(N+npass))**alpha #Number of new cases
Ipos = (1-r)*I + Lpos
Spos = S + B - Lpos
Rpos = N-(Spos+Ipos)</p>
<p># Update stats
self.parentSite.totalcases += Lpos #update number of cases
self.parentSite.incidence.append(Lpos)</p>
<p># Raise site infected flag and add parent site to the epidemic history list.
if not self.parentSite.infected:</p>
<blockquote>
<div><dl class="simple">
<dt>if Lpos &gt; 0:</dt><dd><p>self.parentSite.infected = self.parentSite.parentGraph.simstep
self.parentSite.parentGraph.epipath.append(
(self.parentSite.parentGraph.simstep,
self.parentSite,self.parentSite.infector))</p>
</dd>
</dl>
</div></blockquote>
<p>self.parentSite.migInf.append(Ipos)</p>
<p>return [0,Ipos,Spos]</p>
</dd>
</dl>
</div></blockquote>
<p>Let’s analyze the above code. The first thing to notice is that an
Epigrass custom model is a Python program. So anything you can do with
Python in your system, you can do in your custom model. Naturally, your
knowledge of the Python programming language will define how far you can
go in this customization. There are a few requirements on this Python
program in order to make it a valid custom model from Epigrass’s
perspective.</p>
<ol class="arabic">
<li><p>It must define a global function named <strong>Model</strong>. This function will be inserted as a method on every node object, at run time.</p>
<p>:   1.</p>
<blockquote>
<div><blockquote>
<div><p>This function must declare the following arguments:</p>
<dl class="simple">
<dt>:   -   <em>self</em>: reference to the model object.</dt><dd><ul class="simple">
<li><p><em>vars</em>: A list with the values of the model’s state
variables in time t-1 in the same order as returned
by this function.</p></li>
<li><p><em>par</em>: The parameters of the model. Listed in the
same order as defined in the
<a href="#id3"><span class="problematic" id="id4">`</span></a>.epg`{.interpreted-text role=”file”} file.</p></li>
<li><p><em>theta</em>: Number of infectious individuals arriving
from neighboring sites. For disconnected models, it
is 0.</p></li>
<li><p><em>npass</em>: The total number of passengers arriving
from neighboring sites. For disconnected models, it
is 0.</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>In the beginning of the function you define a list of
strings (self.parentSite.vnames) which will be the names
used when storing the resulting time-series in the database.
Choose strings that are not very long and are meaningful.
You only need to do this once, ate the beginning of the
simulation so put it inside an <em>if</em> statement, which will be
executed only at time-step 1 (see code above).</p></li>
<li><p>After defining variable names, set their initial values in
the same <em>if</em> clause. An <em>else</em> clause linked to this one
will set variables values for the rest of the simulation.</p></li>
<li><p>Define local names for the total population <em>N</em> and fixed
parameters.</p></li>
</ol>
<p>5.  Proceed to implement your model anyway you see fit.
6.</p>
<blockquote>
<div><p>Feed some site level variables (<em>incidence</em>,) with the result of the simulation.</p>
<dl class="simple">
<dt>:   -   <em>incidence</em>: list of new cases per time step.</dt><dd><ul class="simple">
<li><p><em>infected</em>: Boolean stating if the site has been
infected, i.e., it has had an autoctonous case.</p></li>
<li><p><em>epipath</em>: This variable is at the graph level and
contains the path of spread of the simulation.</p></li>
<li><p><em>migInf</em>: Number of infectious individuals in this
site per time-step.</p></li>
</ul>
</dd>
</dl>
</div></blockquote>
<ol class="arabic simple" start="7">
<li><p>Finally, this function must return a list/tuple with the
values of the state variables in the same order as received
in vars.</p></li>
</ol>
</div></blockquote>
</li>
</ol>
<p>&gt; ::: {.warning}
&gt; ::: {.admonition-title}
&gt; Warning
&gt; :::
&gt;
&gt; The strings in self.parentSite.vnames must be valid <em>SQL</em> variable
&gt; names, or else you will have a insert error at the end of the
&gt; simulation.
&gt; ::</p>
<p>After defining this function with all its required features, you can
continue to develop you custom model, writing other functions classes,
etc. Note however, that only the <em>Model</em> function will be called by
Epigrass, so any other code you add to your program must be called from
within that function.</p>
<p>::: {.note}
::: {.admonition-title}
Note
::</p>
<p>Since <a href="#id5"><span class="problematic" id="id6">`</span></a>CustomModel`{.interpreted-text role=”file”} is imported from
within Epigrass, any global code (unindented) in it is also executed. So
you may add imports and other initialization code.
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">warning</span><span class="p">}</span>
<span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">admonition</span><span class="o">-</span><span class="n">title</span><span class="p">}</span>
</pre></div>
</div>
<p>Warning
::</p>
<p>The name CustomModel.py is case-sensitive and cannot be changed. The
same is true for the <em>Model</em> function.
::</p>
</div>
<div class="section" id="the-environment">
<h2>The Environment<a class="headerlink" href="#the-environment" title="Permalink to this headline">¶</a></h2>
<p>![Nesting of the objects inside a Simulate object.](Diagrama1.png)</p>
<p>From quickly going through the example Custom model above it probably
became clear, to the Python-initiated, that Yous can access variables at
the node and graph levels. This is possible because <em>Model</em> becomes a
method in a node object which in is turn is contained into a graph
object (see figure).</p>
<p>Besides being nested within the <em>graph</em> object, <em>node</em> and <em>edge</em>
contain references to their containers. This means that using the
introspective abilities of Python the user can access any information at
any level of the full <em>graph</em> model and use it in the custom model. In
order to help you do this, Let’s establish an API for developing custom
models.</p>
<p>### Model Development API</p>
<p>All attributes and methods (functions) from all around the simulation
must be references from the model’s perspective, denoted by <em>self</em>. The
parent objects can be accessed through the following notation:</p>
<ul>
<li><p><em>self.parentSite</em></p>
<p>:   Is the Site (node) containing the model.</p>
</li>
<li><p><em>self.parentSite.parentGraph</em></p>
<p>:   Is the Graph containing the parent site of the model.</p>
</li>
</ul>
<p>The following attributes and methods can be accessed by appending them
to one one the objects above. For example:</p>
<blockquote>
<div><p>self.parentSite.parentGraph.simstep</p>
</div></blockquote>
<p>#### Site Attributes and Methods</p>
<p>Not all attributes and methods are listed, only the most useful. For a
complete reference, look at the source code documentation.</p>
<p>::: {.Site}
self.parentSite. Actually named <em>siteobj</em> in the source code.</p>
<p>::: {.attribute}
bi</p>
<p>Dictionary with initial values for all of the model’s state variables.
Keys are the variable names.
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>bp</p>
<p>Dictionary with initial values for all of the model’s parameters. Keys
are the parameter names.
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>totpop</p>
<p>Initial total population
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>ts</p>
<p>List containing the model output time series (variables in the same
order of the model)
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>incidence</p>
<p>Incidence time series
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>infected</p>
<p>Has the site been already infected? (logical variable)
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>sitename</p>
<p>Site’s name (provided in the .csv)
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>values</p>
<p>Tuple containing extra-variables provided by .csv file
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>parentGraph</p>
<p>Graph to which Site belongs (see class Graph)
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>edges</p>
<p>List containing all edge objects connected to Site
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>inedges</p>
<p>List containing all inbound edges
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>outedges</p>
<p>List containing all outbound edges
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>geocode</p>
<p>Site’s geocode
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>modtype</p>
<p>Type of dynamic model running in Site
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>vaccination</p>
<p>Time and coverage of vaccination event. Format as in .epg
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>vaccineNow</p>
<p>Flag indicating that it is vaccine day (0 or 1)
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>vaccov</p>
<p>Current vaccination coverage
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">method</span><span class="p">}</span>
</pre></div>
</div>
<p>vaccinate(cov)</p>
<p>At time t, the population is vaccinated with coverage cov
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">method</span><span class="p">}</span>
</pre></div>
</div>
<p>getOutEdges()</p>
<p>Returns list of outbound edges
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">method</span><span class="p">}</span>
</pre></div>
</div>
<p>getInEdges()</p>
<p>Returns list of inbound edges
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">method</span><span class="p">}</span>
</pre></div>
</div>
<p>getNeighbors()</p>
<p>Returns a dictionary of neighbor sites as keys and distances as values
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">method</span><span class="p">}</span>
</pre></div>
</div>
<p>getDistanceFromNeighbor(site)</p>
<p>Returns the distance in km from a given neighbor
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">method</span><span class="p">}</span>
</pre></div>
</div>
<p>getDegree(site)</p>
<p>Returns degree of this site, that is, the number of sites connected to
it
:::
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#### Graph Attributes and Methods</span>
</pre></div>
</div>
<p>Not all attributes and methods are listed, only the most useful. For a
complete reference, look at the source code documentation.</p>
<p>::: {.Graph}
self.parentSite.parentGraph</p>
<p>::: {.attribute}
simstep</p>
<p>Time-step of the simulation. Use it to keep track of the simulation
progress.
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>speed</p>
<p>The speed of the transportation system
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>maxstep</p>
<p>Final time-step of the simulation
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>episize</p>
<p>Current size of the epidemic, graph-wise.
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>site_list</p>
<p>Full list of nodes in the graph. Each element in this list is a real
node object.
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">attribute</span><span class="p">}</span>
</pre></div>
</div>
<p>edge_list</p>
<p>Full list of nodes in the graph. Each element in this list is a real
node object.
::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:::</span> <span class="p">{</span><span class="o">.</span><span class="n">method</span><span class="p">}</span>
</pre></div>
</div>
<p>getSite(name)</p>
<p>Returns an site object named <em>name</em>
:::
::</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/MEMO_logo_pq.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="index.html">Epigrass</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview of Epigrass</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Building and Installing {#install}</a></li>
<li class="toctree-l1"><a class="reference internal" href="intromodels.html">Epidemic Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="using.html">Using Epigrass {#using}</a></li>
<li class="toctree-l1"><a class="reference internal" href="analysis.html">Analysis</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Writing Custom Models {#custom}</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-environment">The Environment</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="analysis.html" title="previous chapter">Analysis</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2008, Flávio Codeço Coelho.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/scripting.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>